{% extends "dashboard/dashboard.html" %}

{% block title %}{{ title }}{% endblock %}

{% block dashboard_content %}

<div class="control-bar">

  <h5 class="control-bar-title">
    <img src="{{ url_for('static', filename='icons/catalogs-white.svg') }}" alt="Catalog" class="title-icon">
    {{ title }}
  </h5>

  <button class="button-link back-btn" data-back="{{ back_url or '/' }}">
    <img src="{{ url_for('static', filename='icons/arrow-back-white.svg') }}" alt="Back" class="btn-icon">
    Regresar
  </button>

</div>

<div class="box autofit dark left">
  <p class="box-subtitle-white">
    Carga un <strong>CSV-UTF-8 (.csv)</strong> o <strong>Excel (.xlsx)</strong> con columnas que coincidan con los campos esperados.
  </p>

  <form id="import-form"
        class="form-grid"
        method="POST"
        action="{{ import_api_url }}"
        enctype="multipart/form-data"
        data-expected-fields='{{ expected_fields|tojson }}'>

    <div class="form-row">
      <label for="file">Archivo</label>
      <input class="button norm button-dark" id="file" name="file" type="file" accept=".csv,.xlsx" required>
    </div>

    <div class="form-row">
      <label>Campos esperados</label>
      <div class="pill-group">
        {% for f in expected_fields %}
          <span class="pill">{{ f }}</span>
        {% endfor %}
      </div>
    </div>

    <div class="form-row">
      <label>Encabezado CSV sugerido</label>
      <pre class="code">{{ expected_fields|join(',') }}</pre>
    </div>

    <div class="form-row">
      <label>Vista de columnas</label>
      <div class="table-mini">
        <table>
          <thead>
            <tr>
              {% for col in expected_columns %}
                <th>{{ col.title }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            <tr>
              {% for col in expected_columns %}
                <td><em>"{{ col.field }}"</em></td>
              {% endfor %}
            </tr>
          </tbody>
        </table>
      </div>
    </div>

<!-- ... arriba todo igual ... -->

<div class="form-footer">
  <!-- Columna izquierda: acciones -->
  <div class="form-actions">
    <a class="button bt-full button-secondary" href="{{ back_url or '/' }}">
      <img src="{{ url_for('static', filename='icons/cancel-white.svg') }}" class="btn-icon" alt="">
      Cancelar
    </a>

    <button type="button" class="button bt-full button-warning" id="btn-excel-template"
            data-template-url="{{ template_xlsx_url }}">
      <img src="{{ url_for('static', filename='icons/download-black.svg') }}" class="btn-icon" alt="">
      Plantilla Excel (.xlsx)
    </button>

    <button type="button" class="button bt-full button-danger" id="btn-csv-template">
      <img src="{{ url_for('static', filename='icons/download-white.svg') }}" class="btn-icon" alt="">
      Plantilla CSV (.csv)
    </button>

    {% set is_stub = (import_api_url == '#' or not import_api_url) %}
    <button type="{{ 'button' if is_stub else 'submit' }}"
            class="button bt-full button-success" {{ 'disabled' if is_stub else '' }}
            id="btn-upload">
      <img src="{{ url_for('static', filename='icons/upload-white.svg') }}" class="btn-icon" alt="">
      Importar
    </button>
  </div>

  <!-- Columna derecha: resultado (mismo id → el JS sigue igual) -->
  <div id="import-result" class="result-panel hidden" aria-live="polite">
    <h4 class="result-title">Resultado de la importación</h4>
    <div id="import-summary" class="result-summary"></div>

    <div id="import-errors" class="mt-2 hidden">
      <h5 class="result-subtitle">Errores</h5>
      <div class="table-mini">
        <table>
          <thead>
            <tr><th>Fila</th><th>Error</th></tr>
          </thead>
          <tbody id="import-errors-body"></tbody>
        </table>
      </div>
      <button type="button" class="button button-secondary mt-2" id="btn-download-errors">
        Descargar errores (.csv)
      </button>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/components/sidebar.js') }}?v={{ ASSET_VERSION }}"></script>
<script src="{{ url_for('static', filename='js/models/import_catalog_items.module.js') }}?v={{ ASSET_VERSION }}" type="module"></script>
{% endblock %}
