{% extends "dashboard/dashboard.html" %}

{% block title %}{{ title }}{% endblock %}

{% block dashboard_content %}

  <div class="control-bar">
    <h5 class="control-bar-title">
      {{ emoji or "üìÅ" }} {{ title }}
    </h5>

    <button class="button-link back-btn" data-back="{{ back_url or '/' }}">
      <img src="{{ url_for('static', filename='icons/arrow-back-white.svg') }}" alt="Back" class="btn-icon">
      Regresar
    </button>

    {% if creatable %}
      <button
        class="button button-success"
        id="btn-create-item" 
        data-model="{{ model_name }}"
        data-url-template="{{ create_url_template }}">
        <img src="{{ url_for('static', filename='icons/add-item-white.svg') }}" alt="Create" class="btn-icon">
        Agregar
      </button>
    {% endif %}

    {% if exportable %}
      <button
        class="button button-warning"
        id="btn-export">
        <img src="{{ url_for('static', filename='icons/download-black.svg') }}" alt="Export" class="btn-icon">
        Exportar
      </button>
    {% endif %}

    {% if importable %}
      <button
        class="button button-danger"
        id="btn-import"
        data-model="{{ model_name }}"
        data-url-template="{{ import_url_template }}">
        <img src="{{ url_for('static', filename='icons/upload-white.svg') }}" alt="Export" class="btn-icon">
        Importar
      </button>
    {% endif %}

    {% if debug_status_url %}
      <div id="debug-status"
          class="debug-chip"
          data-debug-url="{{ debug_status_url }}"
          role="status"
          aria-live="polite">
        ‚è≥ comprobando‚Ä¶
      </div>
    {% endif %}
    
    <button class="button button-dark toggle-filters-btn" type="button" id="toggle-filters">
      <img src="{{ url_for('static', filename='icons/filters-white.svg') }}" class="btn-icon" />
      Filtros
    </button>
  </div>

  {% if filters %}
    <div class="filters-bar">
      <form id="filters-form" class="filters-form">
        {% for f in filters %}
          {% if f.type == "select" %}
            <div class="filter-group">
              <select name="{{ f.field }}">
                <option value="">
                  {{ f.label or f.field.replace('_id', '').replace('_', ' ').capitalize() }}
                </option>
                {% for option in f.options %}
                  <option value="{{ option.value }}">{{ option.label }}</option>
                {% endfor %}
              </select>
            </div>

          {% elif f.type == "date" %}
            {% set base = f.field.replace('_from', '').replace('_to', '') %}
            {% set is_from = '_from' in f.field %}
            {% set is_to = '_to' in f.field %}
            {% set label_base = base.replace('_', ' ').capitalize() %}

            {% if is_from %}
              <div class="filter-group filter-date-pair option-a-style">
                <span class="date-label">{{ label_base }}:</span>
                <input type="date"
                      name="{{ f.field }}"
                      placeholder="Desde"
                      class="date-filter-input" />
            {% elif is_to %}
                <span class="date-label ml-6">‚ñ∑</span>
                <input type="date"
                      name="{{ f.field }}"
                      placeholder="Hasta"
                      class="date-filter-input" />
              </div>
            {% endif %}

          {% else %}
            <div class="filter-group">
              <input type="text"
                    name="{{ f.field }}"
                    placeholder="{{ f.label or f.field.replace('_', ' ').capitalize() }}"
                    autocomplete="off">
            </div>
          {% endif %}
        {% endfor %}

        <button class="button button-dark filter-btn" type="submit">üîç Filtrar</button>
        <button class="button button-dark clear-btn" type="button">‚ùå Limpiar</button>
      </form>
    </div>
  {% endif %}

  <div class="table-wrapper">
    <div class="scroll-warning">
      üì± Desliza a la derecha para ver toda la tabla ‚Üí
    </div>

    <div id="model-table" class="tabulator-container" 
      data-model="{{ model_name }}"
      data-editable="{{ editable|lower }}"
      data-deletable="{{ deletable|lower }}"
      data-creatable="{{ creatable|lower }}"
      data-importable="{{ importable|lower }}"
      data-columns='{{ columns|tojson }}'
      data-save-url="{{ save_url }}"
      data-view-url-template="{{ view_url_template }}"
      data-action-url-template="{{ action_url_template }}"
      data-print-url-template="{{ print_url_template }}"
      data-assign-choices-endpoint="{{ assign_choices_endpoint or '' }}"
      data-assign-payload-field="{{ assign_payload_field or '' }}"
      data-assign-expires="{{ 'true' if assign_expires else 'false' }}"
      data-assign-expires-label="{{ assign_expires_label or '' }}"
      data-export-xlsx-url="{{ export_xlsx_url }}"
      data-export-csv-url="{{ export_csv_url }}"> 
    </div>
  </div>

  <div id="catalog-warning" class="catalog-warning hidden"></div>

  <!-- Modal: Acci√≥n Especial -->
  <div id="extra-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="extra-modal-title">
    <div class="modal-content box center" id="extra-modal-content" aria-live="polite">
      <h2 id="extra-modal-title">‚ö° Acci√≥n Especial</h2>
      <p>Este es un canal para acciones avanzadas por √≠tem.</p>
      <div class="modal-buttons">
        <button
          class="button button-success" 
          onclick="document.getElementById('extra-modal').classList.add('hidden')">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Exportar -->
  <div id="export-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="export-modal-title">
    <div class="modal-content box dark autofit center" aria-live="polite">
      <h2 class="box-title-white" id="export-modal-title">
        <img src="{{ url_for('static', filename='icons/download-white.svg') }}" alt="Export" class="title-icon">
        Exportar
      </h2>
      <p class="modal-subtitle">Elige el formato de exportaci√≥n.</p>
      <p class="modal-meta">
        Se exportar√°n <strong id="export-total">‚Äî</strong> registros.
      </p>
      <div class="modal-buttons">
        <button class="button button-success" id="export-confirm-xlsx">Excel (.xlsx)</button>
        <button class="button button-warning"    id="export-confirm-csv">CSV (.csv)</button>
        <button class="button button-secondary" data-close>Cancelar</button>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/components/sidebar.js') }}?v={{ ASSET_VERSION }}"></script>
<script src="{{ url_for('static', filename='luxon/luxon.min.js') }}?v={{ ASSET_VERSION }}"></script>
<script src="{{ url_for('static', filename='js/tabulator/model_table.module.js') }}?v={{ ASSET_VERSION }}" type="module"></script>
<script src="{{ url_for('static', filename='js/admin/maintenance/debug_status.js') }}?v={{ ASSET_VERSION }}" type="module"></script> 
<script src="{{ url_for('static', filename='js/models/filters_toggle.js') }}?v={{ ASSET_VERSION }}"></script>
<script src="{{ url_for('static', filename='js/models/export_button.module.js') }}?v={{ ASSET_VERSION }}" type="module"></script>
{% endblock %}
